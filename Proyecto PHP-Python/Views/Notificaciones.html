<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Notificaciones | Inventario Win Sports</title>
        <link rel="stylesheet" href="../CSS/styles.css">
        <script src="../Public/JS/scripts.js" defer></script>
        <style>
            .notif-toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
            .notif-toolbar .spacer { flex: 1; }
            .notif-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 14px; }
            .notif-item { margin: 0; display: flex; align-items: flex-start; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 10px; padding: 14px 16px; border-left: 4px solid transparent; background: #fff; }
            .notif-title { font-weight: 700; color: #222; }
            .notif-meta { color: #888; font-size: .85rem; }
            .notif-item.success { background: linear-gradient(135deg, #f3fff5 0%, #ebfff0 100%); border-left-color: #4caf50; }
            .notif-item.info { background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%); border-left-color: #2196f3; }
            .notif-item.warning { background: linear-gradient(135deg, #fff9f0 0%, #fff5e6 100%); border-left-color: #ff9800; }
            .notif-item.error { background: linear-gradient(135deg, #fff0f0 0%, #ffe6e6 100%); border-left-color: #f44336; }
            .chip { padding: 2px 8px; border-radius: 100px; font-size: .75rem; color: #fff; }
            .chip.success { background: #4caf50; }
            .chip.info { background: #2196f3; }
            .chip.warning { background: #ff9800; }
            .chip.error { background: #f44336; }
            .muted { opacity: .6; }
            .notif-form { margin-top: 22px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: end; }
            .notif-form .row { display: contents; }
            .notif-form .span2 { grid-column: span 2; }
            @media (max-width: 700px) { .notif-form { grid-template-columns: 1fr; } .notif-form .span2 { grid-column: span 1; } }
        </style>
</head>
<body>
        <header class="site-header">
            <div class="container header-inner">
                <h1 class="brand">Win Sports <span class="accent">Notificaciones</span></h1>
                <nav class ="nav">
                    <a href="./index.html">Inicio</a>
                    <a href="./Bases_de_Datos/Base_de_Datos.html">Base de Datos</a>
                    <a href="./Identificadores/Lectores.html">Lectores</a>
                    <a href="./Guia_Rapida.html">Guía</a>
                </nav>
            </div>
        </header>
        <main class="container" style="margin-top: 40px;">
            <section class="database-section animate" style="width: 100%; max-width: 1200px; margin: 0 auto;">
                <div class="section-header animate">
                    <h2 style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 2rem; color: var(--accent, #f50);"></span> Notificaciones
                    </h2>
                    <div class="notif-toolbar" style="margin-top: 10px;">
                        <div>
                            <button class="btn" id="btn-refresh" type="button">Refrescar</button>
                            <button class="btn" id="btn-mark-all" type="button">Marcar todas como leídas</button>
                            <button class="btn" id="btn-clear" type="button">Borrar todas</button>
                        </div>
                        <div class="spacer"></div>
                        <div>
                            <select id="filter-type" class="filter-input" style="min-width: 160px;">
                                <option value="">Todas</option>
                                <option value="info">Informativas</option>
                                <option value="success">Exitosas</option>
                                <option value="warning">Advertencias</option>
                                <option value="error">Errores</option>
                            </select>
                            <label style="margin-left:10px; font-size:.95rem;">
                                <input type="checkbox" id="filter-unread"> Solo no leídas
                            </label>
                        </div>
                    </div>
                </div>
                <div style="margin: 24px 0; width: 100%;">
                    <ul id="notif-list" class="notif-list"></ul>
                    <div id="notif-empty" class="note" style="display:none;">No hay notificaciones.</div>
                    <div id="notif-error" class="note" style="display:none; color:#b00020; border-left:4px solid #b00020;">No se pudo comunicar con el servidor. Abre la app con un servidor (no file://).</div>
                    <div class="notif-form animate">
                        <div class="row">
                            <div>
                                <label for="nf-type">Tipo</label>
                                <select id="nf-type" class="filter-input" style="width:100%;">
                                    <option value="info">Informativa</option>
                                    <option value="success">Exitosa</option>
                                    <option value="warning">Advertencia</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>
                            <div>
                                <label for="nf-title">Título</label>
                                <input id="nf-title" class="filter-input" type="text" placeholder="Título" />
                            </div>
                            <div class="span2">
                                <label for="nf-message">Mensaje</label>
                                <input id="nf-message" class="filter-input" type="text" placeholder="Mensaje" />
                            </div>
                            <div>
                                <button class="btn primary" id="btn-add-notif" type="button">Agregar</button>
                            </div>
                            <div>
                                <button class="btn secondary" id="btn-seed-notifs" type="button">Agregar 3 de ejemplo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <script>
        function timeAgo(iso){
            const d = new Date(iso); const diff = (Date.now()-d.getTime())/1000;
            if (diff<60) return 'hace ' + Math.floor(diff) + 's';
            if (diff<3600) return 'hace ' + Math.floor(diff/60) + 'm';
            if (diff<86400) return 'hace ' + Math.floor(diff/3600) + 'h';
            return d.toLocaleString();
        }
        const API_ABS = '/Public/PHP/notifications.php';
        const API_REL = '../Public/PHP/notifications.php';
        async function apiFetch(url, options){
            try { const r = await fetch(url, options); if (r.ok) return r; } catch(_) {}
            const fallback = url.replace(API_ABS, API_REL);
            return fetch(fallback, options);
        }
        async function fetchNotifications(){
            const type = document.getElementById('filter-type').value;
            const unread = document.getElementById('filter-unread').checked ? '1' : '';
            const query = (type||unread) ? `?type=${encodeURIComponent(type)}&unread=${unread}` : '';
            const res = await apiFetch(API_ABS + query);
            let json; try { json = await res.json(); } catch(_) { throw new Error('Respuesta inválida del servidor'); }
            if(!res.ok || !json.success){ throw new Error(json && json.error ? json.error : 'No se pudieron cargar notificaciones'); }
            return json.items || [];
        }
        function renderNotifications(items){
            const list = document.getElementById('notif-list');
            const empty = document.getElementById('notif-empty');
            list.innerHTML='';
            if(!items.length){ empty.style.display='block'; return; }
            empty.style.display='none';
            items.forEach(n=>{
                const li = document.createElement('li');
                li.className = `notif-item ${n.type||'info'} ${n.read?'muted':''}`;
                li.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div class="notif-title">${n.title} <span class="chip ${n.type}">${(n.type||'info').toUpperCase()}</span></div>
                        <div>${n.message||''}</div>
                        <div class="notif-meta">${timeAgo(n.time)}</div>
                    </div>`;
                list.appendChild(li);
            });
        }
        async function refresh(){
            const err = document.getElementById('notif-error');
            try{ const items = await fetchNotifications(); renderNotifications(items); if(err) err.style.display='none'; }
            catch(e){ if(err){ err.textContent = 'Error: ' + (e.message||e); err.style.display='block'; } }
        }
        async function postAction(action, payload={}){
            const res = await apiFetch(API_ABS, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify(Object.assign({action}, payload))
            });
            const json = await res.json();
            if(!res.ok || !json.success){ throw new Error(json.error||'Acción falló'); }
            return json;
        }
        document.addEventListener('DOMContentLoaded', ()=>{
            const err = document.getElementById('notif-error');
            const btnRefresh = document.getElementById('btn-refresh');
            const btnMarkAll = document.getElementById('btn-mark-all');
            const btnClear = document.getElementById('btn-clear');
            const btnAdd = document.getElementById('btn-add-notif');
            const btnSeed = document.getElementById('btn-seed-notifs');

            btnRefresh.addEventListener('click', refresh);
            btnMarkAll.addEventListener('click', async ()=>{
                btnMarkAll.disabled = true;
                try { await postAction('mark_all_read'); await refresh(); if(err) err.style.display='none'; }
                catch(e){ if(err){ err.textContent = 'Error: ' + (e.message||e); err.style.display='block'; } }
                finally { btnMarkAll.disabled = false; }
            });
            btnClear.addEventListener('click', async ()=>{
                if(!confirm('¿Borrar todas?')) return;
                btnClear.disabled = true;
                try { await postAction('clear_all'); await refresh(); if(err) err.style.display='none'; }
                catch(e){ if(err){ err.textContent = 'Error: ' + (e.message||e); err.style.display='block'; } }
                finally { btnClear.disabled = false; }
            });
            document.getElementById('filter-type').addEventListener('change', refresh);
            document.getElementById('filter-unread').addEventListener('change', refresh);
            btnAdd.addEventListener('click', async ()=>{
                const type = document.getElementById('nf-type').value;
                const title = document.getElementById('nf-title').value || 'Notificación';
                const message = document.getElementById('nf-message').value || '';
                btnAdd.disabled = true;
                try { await postAction('add', { type, title, message }); await refresh(); if(err) err.style.display='none'; }
                catch(e){ if(err){ err.textContent = 'Error: ' + (e.message||e); err.style.display='block'; } }
                finally {
                    document.getElementById('nf-title').value='';
                    document.getElementById('nf-message').value='';
                    btnAdd.disabled = false;
                }
            });
            btnSeed.addEventListener('click', async ()=>{
                btnSeed.disabled = true;
                try {
                    await postAction('add', { type:'success', title:'Operación exitosa', message:'El inventario fue actualizado' });
                    await postAction('add', { type:'warning', title:'Advertencia', message:'Quedan pocos elementos críticos' });
                    await postAction('add', { type:'error', title:'Error', message:'Falló la sincronización con el servidor' });
                    await refresh(); if(err) err.style.display='none';
                } catch(e){ if(err){ err.textContent = 'Error: ' + (e.message||e); err.style.display='block'; } }
                finally { btnSeed.disabled = false; }
            });
            refresh();
        });
        </script>
    
</body>
</html>